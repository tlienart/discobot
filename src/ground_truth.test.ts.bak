import { expect, test, describe, afterEach, beforeEach } from 'bun:test';
import { OpenCodeAgent, type OpenCodeEvent } from './opencode';
import { existsSync, mkdirSync, rmSync } from 'fs';
import { join } from 'path';

/**
 * GROUND TRUTH TESTS
 * These tests perform REAL executions (no mocks) to verify the
 * OS-level integration between the Bridge, Fence, and OpenCode.
 */
describe('Ground Truth: Sandbox & Engine Integration', () => {
  const TEST_WORKSPACE = './ground-truth-workspace';

  beforeEach(() => {
    process.env.USE_SANDBOX = 'true';
    process.env.SANDBOX_WORKSPACE_DIR = TEST_WORKSPACE;
    if (!existsSync(TEST_WORKSPACE)) mkdirSync(TEST_WORKSPACE, { recursive: true });
  });

  afterEach(() => {
    if (existsSync(TEST_WORKSPACE)) {
      rmSync(TEST_WORKSPACE, { recursive: true, force: true });
    }
  });

  test('should successfully wrap opencode run and receive JSON events', async () => {
    // Start without a session ID to let it generate a fresh one
    const agent = new OpenCodeAgent();
    let capturedEvents: string[] = [];
    let outputReceived = false;

    agent.on('event', (e: OpenCodeEvent) => {
      capturedEvents.push(e.type);
    });

    agent.on('output', (text: string) => {
      if (text.toLowerCase().includes('hello world')) {
        outputReceived = true;
      }
    });

    console.log('[GT] Starting real agent execution...');
    await agent.start('echo hello world');

    expect(capturedEvents).toContain('step_start');
    expect(capturedEvents).toContain('step_finish');
    expect(outputReceived).toBe(true);
  }, 30000); // 30s timeout for real execution

  test('should strictly block access to root .env via absolute path', async () => {
    const agent = new OpenCodeAgent('ses_gt-security-test');
    let violationCaught = false;

    agent.on('sandbox_violation', (msg) => {
      console.log(`[GT] Caught expected violation: ${msg}`);
      violationCaught = true;
    });

    const rootEnvPath = join(process.cwd(), '.env');
    console.log(`[GT] Testing absolute path block for: ${rootEnvPath}`);

    // We expect this to fail or be blocked
    await agent.start(`cat ${rootEnvPath}`);

    expect(violationCaught).toBe(true);
  }, 40000);
});
